# Comfy Factory

Windows 7 に標準搭載されていた「Purble Place」のケーキ作りミニゲームのクローンです。
注文カードに表示されるケーキを、ベルトコンベア上で組み立てて提出します。

---

## 目次

1. [ゲーム概要](#ゲーム概要)
2. [要件](#要件)
3. [事前準備](#事前準備)
4. [インストール](#インストール)
5. [ビルド・実行](#ビルド実行)
6. [操作マニュアル](#操作マニュアル)
7. [フォルダ構造](#フォルダ構造)
8. [技術設計](#技術設計)
9. [改善ポイント](#改善ポイント)
10. [運用面でのネクストアクション](#運用面でのネクストアクション)

---

## ゲーム概要

| 項目 | 内容 |
|------|------|
| ジャンル | ケーキ組み立てパズル |
| プレイヤー | 1人 |
| クリア条件 | 3つの注文を正しく完成させる |
| ゲームオーバー | 提出時に5回間違える |
| 操作 | マウスクリック + ◀▶ ボタン |

### ルール

- 画面左の **注文カード** に完成形のケーキが表示されます
- ベルトコンベア上で、注文どおりにケーキを組み立てます
- 各工程で素材を選び、**▶ ボタン** で確定して次の工程へ進みます
- 全工程を完了すると ▶ が **「提出」** に変わり、クリックで判定されます
- **完全一致** で合格、1つでも違えばミスになります
- ミス時は同じ注文をやり直します（ケーキはリセットされます）

### 素材一覧

| カテゴリ | 選択肢 |
|---------|--------|
| ベース（スポンジ） | バニラ / チョコ / ストロベリー |
| クリーム | ホイップ / チョコ / いちご |
| トッピング | チェリー / クッキー / ナッツ |
| 飾り（注文3のみ） | スプリンクル / チョコチップ / スター |
| ソース（注文3のみ） | キャラメル / チョコ / ストロベリー |

### 難易度

- **注文 1〜2**: 3工程（ベース → クリーム → トッピング）
- **注文 3**: 5工程（ベース → クリーム → トッピング → 飾り → ソース）

---

## 要件

### 必須ソフトウェア

| ソフトウェア | バージョン | 用途 |
|-------------|-----------|------|
| **g++ (MinGW-w64)** | 10以上（C++17対応） | C++ バックエンドのコンパイル |
| **Node.js** | 18以上 | npm / TypeScript コンパイル |
| **npm** | 9以上 | パッケージ管理 |

### 動作確認済み環境

- Windows 11 + MinGW-w64 (g++ 15.2) + Node.js 24
- ブラウザ: Chrome / Edge / Firefox（ES2020対応の最新ブラウザ）

---

## 事前準備

### 1. g++ (MinGW-w64) の確認

```bash
g++ --version
```

インストールされていない場合は [MSYS2](https://www.msys2.org/) 等からインストールしてください。

### 2. Node.js / npm の確認

```bash
node --version
npm --version
```

インストールされていない場合は [Node.js 公式サイト](https://nodejs.org/) からインストールしてください。

---

## インストール

### 1. リポジトリをクローン

```bash
git clone <リポジトリURL>
cd comfy-factory
```

### 2. npm パッケージをインストール

```bash
npm install
```

TypeScript コンパイラ (`typescript`) が `node_modules/` にインストールされます。

---

## ビルド・実行

### ワンコマンドで起動（推奨）

```bash
npm start
```

以下が自動で行われます:

1. TypeScript のコンパイル（`frontend/game.ts` → `frontend/game.js`）
2. C++ のコンパイル（`src/*.cpp` → `server.exe`）
3. サーバー起動（ポート 9000）
4. デフォルトブラウザで `http://127.0.0.1:9000` を自動オープン

停止は **Ctrl+C** です。

### 個別コマンド

| コマンド | 動作 |
|---------|------|
| `npm run build` | ビルドのみ（起動しない） |
| `npm run build:ts` | TypeScript のみコンパイル |
| `npm run build:cpp` | C++ のみコンパイル |
| `make run` | Makefile 経由でビルド＋起動 |
| `make clean` | ビルド成果物を削除 |

### ポート番号の変更

デフォルトは **9000** です。変更する場合は `src/main.cpp` の以下の2箇所を編集してリビルドしてください:

```cpp
std::cout << "  http://127.0.0.1:9000" << std::endl;  // 表示用
server.listen(9000);                                    // 実際のポート
```

---

## 操作マニュアル

### 画面構成

```
┌────────────────────────────────────────────────────┐
│                 Comfy Factory                      │
│          注文 1/3   スコア: 0   ライフ: ♥♥♥♥♥     │
├────────┬───────────────────────────────────────────┤
│        │     ● ─── ○ ─── ○   ステップ進捗        │
│  注文  │    ベース  クリーム  トッピング            │
│  カード │                                          │
│ (完成形)│   ◀    [ ケーキ組立中 ]    ▶            │
│        │   ═══════════════════════  ベルトコンベア  │
│        │                                          │
│        │   [バニラ] [チョコ] [ストロベリー]         │
└────────┴───────────────────────────────────────────┘
```

| 領域 | 説明 |
|------|------|
| **注文カード**（左） | 完成形のケーキをビジュアルで表示。常に参照可能 |
| **ステップ進捗**（上部） | 現在の工程を色付きドットで表示 |
| **ベルトコンベア**（中央） | ケーキが組み立てられていく場所 |
| **◀ ▶ ボタン**（コンベア両側） | 工程の移動 |
| **素材ボタン**（下部） | 現在の工程で選べる素材 |
| **ライフ**（ヘッダー） | 残りライフ（♥ = 残り / ♡ = 失った） |

### 操作手順

1. **素材を選ぶ** — 素材ボタンをクリックすると選択状態になり、ケーキにプレビューが表示されます
2. **▶（次へ）** — 選択を確定して次の工程へ進みます
3. **◀（戻る）** — 未確定の選択を取り消し、または前の工程に戻ります
4. **提出** — 全工程完了後、▶ が「提出」ボタンに変わります。クリックで判定

### ボタンの状態

| ボタン | 有効条件 |
|-------|---------|
| **◀** | 素材を選択中、または1つ以上の工程を確定済み |
| **▶** | 素材を選択中 |
| **提出** | 全工程が確定済み |

### 判定結果

| 結果 | 動作 |
|------|------|
| **正解** | 「正解！」と表示 → スコア加算 → 次の注文へ |
| **不正解** | 「不正解...」と表示 → ミス加算 → 同じ注文をやり直し |
| **ゲームクリア** | 3つ全ての注文を正しく完成 → クリア画面 |
| **ゲームオーバー** | ミスが5回に達した → ゲームオーバー画面 |

---

## フォルダ構造

```
comfy-factory/
├── src/                         # C++ バックエンド
│   ├── game.h                   #   ゲームロジック ヘッダー
│   ├── game.cpp                 #   ゲームロジック 実装
│   ├── server.h                 #   HTTP サーバー ヘッダー
│   ├── server.cpp               #   HTTP サーバー 実装
│   └── main.cpp                 #   エントリーポイント・API ルート定義
│
├── frontend/                    # フロントエンド
│   ├── index.html               #   メイン HTML（画面レイアウト）
│   ├── style.css                #   スタイルシート（ケーキ描画・アニメーション）
│   ├── game.ts                  #   TypeScript ソース（UI ロジック）
│   └── game.js                  #   コンパイル済み JS（自動生成・Git対象外）
│
├── package.json                 # npm 設定・ビルドスクリプト
├── package-lock.json            # npm ロックファイル
├── tsconfig.json                # TypeScript コンパイラ設定
├── Makefile                     # Make ビルド設定
├── .gitignore                   # Git 除外設定
└── README.md                    # このファイル
```

### 各ファイルの詳細

#### バックエンド（C++）

| ファイル | 行数目安 | 役割 |
|---------|---------|------|
| `game.h` | ~40行 | `Game` クラスの宣言。状態管理（PLAYING / GAME_OVER / GAME_CLEAR）、素材定数の定義 |
| `game.cpp` | ~120行 | ゲームエンジンの実装。注文生成（`std::mt19937` 乱数）、素材選択、提出判定、やり直し、JSON シリアライズ |
| `server.h` | ~55行 | `HttpServer` クラスの宣言。GET/POST ルーティング、静的ファイル配信。Windows (Winsock2) / POSIX 両対応 |
| `server.cpp` | ~200行 | HTTP/1.1 リクエストパース、レスポンス構築、マルチスレッドクライアント処理、MIME 判定、CORS ヘッダー |
| `main.cpp` | ~80行 | エントリーポイント。5つの REST API エンドポイントを登録。ゲームアクセスは `std::mutex` で排他制御。起動時にブラウザを自動オープン |

#### フロントエンド（TypeScript / HTML / CSS）

| ファイル | 行数目安 | 役割 |
|---------|---------|------|
| `index.html` | ~60行 | ページ構造。注文パネル、ベルトコンベア、素材ボタン、オーバーレイ、フィードバックトースト |
| `style.css` | ~350行 | 全体スタイリング。ケーキ層のCSS描画（グラデーション・clip-path）、ベルトコンベアアニメーション、レスポンシブ対応 |
| `game.ts` | ~280行 | UI ロジック。API 通信、ケーキレンダリング、ペンディング選択管理、◀▶ ナビゲーション、フィードバック表示 |

#### 設定ファイル

| ファイル | 役割 |
|---------|------|
| `package.json` | npm スクリプト定義（`build:ts`, `build:cpp`, `build`, `start`）。依存: `typescript` |
| `tsconfig.json` | TypeScript 設定。ターゲット ES2020、strict モード、DOM ライブラリ |
| `Makefile` | Make ビルド。`all`（TS+C++）、`run`（ビルド＋起動）、`clean`（成果物削除） |
| `.gitignore` | `node_modules/`, `*.exe`, `frontend/game.js` を除外 |

---

## 技術設計

### アーキテクチャ

```
┌──────────────┐     HTTP (JSON)     ┌──────────────────┐
│  ブラウザ     │ ◄──────────────────► │  C++ サーバー     │
│  HTML/TS/CSS  │   localhost:9000    │  game + httpd    │
└──────────────┘                     └──────────────────┘
```

- **バックエンド**: C++ で実装したゲームロジック + 自前の軽量 HTTP サーバー
- **フロントエンド**: HTML/CSS/TypeScript（ブラウザ上で動作）
- **通信**: REST API（JSON）で状態を同期

### API エンドポイント

| メソッド | パス | 説明 |
|---------|------|------|
| `GET` | `/api/state` | 現在のゲーム状態を取得 |
| `POST` | `/api/new-game` | 新しいゲームを開始 |
| `POST` | `/api/select` | 素材を選択 `{"category":"base","value":"vanilla"}` |
| `POST` | `/api/undo` | 最後の選択を取り消し |
| `POST` | `/api/submit` | ケーキを提出して判定 |

---

## 改善ポイント

### 機能面

- **難易度設定**: イージー（注文2回）/ ノーマル（3回）/ ハード（5回）の選択
- **タイマー**: 制限時間を設けてスコアに反映
- **スコアランキング**: ローカルストレージやサーバーサイドでハイスコアを保存
- **サウンド**: BGM、クリック音、正解/不正解の効果音
- **注文パターン強化**: 同じ素材が連続しないようバリエーションを増やす
- **アニメーション強化**: ケーキ完成時のパーティクルエフェクト、ベルトコンベアの移動演出

### 技術面

- **WebSocket 化**: REST ポーリングから WebSocket に切り替え、リアルタイム通信に対応
- **WASM 化**: C++ を Emscripten で WebAssembly にコンパイルし、サーバー不要で動作
- **テスト追加**: C++ ユニットテスト（Google Test）、TypeScript テスト（Jest）
- **ポート設定の外部化**: コマンドライン引数や環境変数でポートを指定
- **画像アセット**: CSS 描画からイラスト素材（SVG/PNG）に置き換えてリッチなビジュアルに
- **CI/CD**: GitHub Actions でビルド・テストを自動化

### コード品質

- **JSON ライブラリ導入**: 手動 JSON 構築から nlohmann/json 等のライブラリに置き換え
- **エラーハンドリング強化**: サーバー側のバリデーション強化、フロントエンドのリトライ処理
- **ログ出力**: 構造化ログの導入（リクエストログ、エラーログ）

---

## 運用面でのネクストアクション

### 短期（すぐできる）

- [ ] GitHub リポジトリにプッシュ
- [ ] GitHub Actions で `npm run build` の CI を設定
- [ ] ポート番号を環境変数 or コマンドライン引数で設定可能にする
- [ ] favicon.ico を追加してブラウザタブにアイコンを表示

### 中期（機能拡充）

- [ ] 効果音・BGM の追加（Web Audio API）
- [ ] ハイスコア保存機能（localStorage）
- [ ] 難易度選択画面の追加
- [ ] モバイル対応の強化（タッチ操作の最適化）

### 長期（アーキテクチャ改善）

- [ ] Emscripten で WASM 化し、GitHub Pages でホスティング
- [ ] マルチプレイ対応（WebSocket + 対戦/協力モード）
- [ ] イラストレーターによるアセット制作
- [ ] i18n 対応（日本語/英語切り替え）

---

## ライセンス

このプロジェクトは個人の学習・趣味目的で作成されたものです。
「Purble Place」は Microsoft の商標です。本プロジェクトは Microsoft との関連はありません。
